\newbox\charbox % Used to mea≈õure character width
\newdimen\charwidth
\newdimen\charheight

\def\dofont#1, #2!{"#1" at #2\relax}
\newdimen\fontsize
\newdimen\serifsize

\input config

% Scale some of the maths fonts down (use 7pt as a base size, not 10). Not all
% fonts are redefined, but it should be enough for normal usage. Add new
% definitions (\subscriptfont, \*font4 -- \*font15) when needed.
\font\sevenex=cmex7
\font\fiveex=cmex5
\textfont0=\sevenrm \scriptfont0=\fiverm
\textfont1=\seveni \scriptfont1=\fivei
\textfont2=\sevensy \scriptfont2=\fivesy
\textfont3=\sevenex \scriptfont3=\fiveex

\seriffam
\rm

\advance\hoffset by -45pt
\advance\hsize by 90pt
\advance\voffset by -50pt
\advance\vsize by 150pt
\parindent=0pt

% Calculates the character width of the actual font into \spacesize
\def\calcchardimens{%
	\setbox\charbox=\hbox{(}%
	\charwidth=\wd\charbox
	\charheight=\ht\charbox
}

% Defines special escape sequences that print {, }, \ when used in monospace
\def\makeprintable{%
	\def\do##1{\catcode`##1=12}%
	\dospecials
	\catcode`\\=0%
	\catcode`\{=1%
	\catcode`\}=2%
	\gdef\{{\char123\relax}%
	\gdef\}{\char125\relax}%
	\gdef\b##1##2{\char92\relax##2}% Backspace
}

% Internal macro which sets up the environment for code listing mode
\def\setverb{%
	% Allow blank lines (otherwise multiple consecutive \par's would be treated as one)
	\def\par{\leavevmode\endgraf}%
	%
	% Allow long lines to break, let them have less \baselineskip (optically),
	% indent line continuations
	\baselineskip=1\fontsize\relax%
	\parskip=1.7pt plus .1pt minus .1pt%
	\rightskip=0pt plus 1fill%
	\leftskip=100pt%
	\parindent=-\leftskip%
	\setsimpleverb
}

% Simplified version used for short code snippets
\def\setsimpleverb{%
	\monofam\rm
	\makeprintable
	\setspace\obeyspaces\obeylines%
}

% Set up fixed spaces, define tab as four spaces
{%
 \catcode`\^^I=13\catcode`\ =13%
 \gdef\setspace{\catcode`\^^I=13\catcode`\ =13%
 \def {\calcchardimens\hskip\charwidth\relax}\def^^I{    }%
}%
}

% TODO: think of some better delimiter than |, try to make { work (\verb|hello}
% is way less cool than \verb{hello})

% Sets up the verbatim environment, end with \egroup
\def\verb|{%
	\bgroup
	\setverb%
}

% Sets up a simplfied verbatim environment, end with \egroup
\def\simpleverb|{%
	\bgroup
	\setsimpleverb%
}

% \col{rgb color}{font}{content}
\def\col#1#2#3{%
	{%
	\special{color push rgb #1}%
	#2%
	#3%
	\special{color pop}%
	}%
}

% Blank lines: we want to encourage page breaks here
% These macros are inserted automatically by the source code preprocessor
\def\sk{\penalty -500} % regular
\def\greatsk{\penalty -3000} % after a function definition (after non-indented "}")

\footline={}
\headline={%
	\vbox{%
		\vskip -5pt

		\headlinefont
		\special{color push rgb 0 0 0}%
		\docname
		\hskip 0pt plus 1filll
		\the\pageno
		\special{color pop}%
		%
		\vskip 3pt
		\hrule height .5pt
	}%
}

% Before the listing of one file
\def\header#1{%
	{%
	\headerfont
	\vskip 15pt plus 3pt minus 8pt
	\penalty -5000
	#1
	\endgraf
	\penalty 5000
	}%
}

% Used to print a hash at the beggining of a line
\def\h#1{%
	\calcchardimens\hskip-4\charwidth
	\hcol{#1}%
}

